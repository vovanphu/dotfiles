#!/bin/bash
{{- if eq .chezmoi.os "linux" -}}

# run_once_install-packages.sh.tmpl
# This script runs only when the hash of this file changes.
# (Force LF normalization)

set -eufo pipefail

echo "Starting Linux Package Installation..."

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Update package lists
if command_exists apt-get; then
    echo "Updating apt repositories..."
    sudo apt-get update
fi

# Pre-install Tailscale via official script (Handle Repos) if missing
if ! command_exists tailscale; then
    echo "Tailscale not found. Running official installer to setup repos..."
    curl -fsSL https://tailscale.com/install.sh | sh
fi

{{- $pkgData := include "packages.yaml" | fromYaml -}}
{{- $linuxData := $pkgData.linux -}}

# Define minimal base packages (String list for POSIX compatibility)
PACKAGES=""
{{- range $linuxData.common -}}
    PACKAGES="$PACKAGES {{ . }}"
{{- end -}}

# Core Tools (Excluded from headless 'server' roles to save resources)
# Only install 'extras' (Neovim, Ripgrep, Starship) on Interactive roles:
if [[ "{{ .role }}" == "centaur" || "{{ .role }}" == "chimera" || "{{ .role }}" == "griffin" ]]; then
{{- range $linuxData.extras -}}
    PACKAGES="$PACKAGES {{ . }}"
{{- end -}}
fi

# Role-specific packages
{{- if hasKey $linuxData.roles .role -}}
    {{- $rolePkgs := index $linuxData.roles .role -}}
    {{- if $rolePkgs }}
    {{- range $rolePkgs -}}
        PACKAGES="$PACKAGES {{ . }}"
    {{- end -}}
    {{- end -}}
{{- end -}}

echo "Installing packages: $PACKAGES"

if command_exists apt-get; then
    # Warning: unquoted variable to allow splitting. 
    # Filter out 'starship' since it's installed via script, not apt.
    APT_PACKAGES=$(echo $PACKAGES | sed 's/starship//g')
    sudo apt-get install -y $APT_PACKAGES
else
    echo "Warning: apt-get not found. Skipping package installation via package manager."
fi

# Install Starship ONLY for Interactive roles (Save RAM/Disk)
# Install Starship if specifically requested in packages.yaml (installed via script, not apt)
if [[ "$PACKAGES" == *"starship"* ]]; then
    if ! command_exists starship; then
        echo "Installing Starship..."
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    else
        echo "Starship already installed."
    fi
fi

# Install Bitwarden CLI if not present
if ! command_exists bw; then
    echo "Installing Bitwarden CLI..."
    # Download the native binary
    curl -L "https://vault.bitwarden.com/download/?app=cli&platform=linux" -o bw.zip
    unzip -o bw.zip
    chmod +x bw
    mkdir -p "$HOME/.local/bin"
    mv bw "$HOME/.local/bin/bw"
    rm bw.zip
fi

# Install FiraCode Nerd Font for Interactive roles
if [[ "{{ .role }}" == "centaur" || "{{ .role }}" == "chimera" || "{{ .role }}" == "griffin" ]]; then
    FONT_DIR="$HOME/.local/share/fonts"
    # Check if font already exists to avoid re-downloading
    if [[ ! -f "$FONT_DIR/FiraCodeNerdFont-Regular.ttf" ]]; then
        echo "Installing FiraCode Nerd Font..."
        mkdir -p "$FONT_DIR"
        
        # Ensure unzip is available
        if ! command_exists unzip; then
             if command_exists apt-get; then
                 echo "Installing unzip for font extraction..."
                 sudo apt-get install -y unzip
             fi
        fi

        # Download and install
        curl -fLo "/tmp/FiraCode.zip" https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip
        unzip -o -q "/tmp/FiraCode.zip" -d "$FONT_DIR"
        rm "/tmp/FiraCode.zip"
        
        if command_exists fc-cache; then
            echo "Updating font cache..."
            fc-cache -f "$FONT_DIR"
        fi
        echo "FiraCode Nerd Font installed successfully."
    else
        echo "FiraCode Nerd Font already installed."
    fi
fi

echo "Linux Package Installation Complete!"
{{- end -}}
