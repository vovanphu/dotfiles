{{- if eq .chezmoi.os "windows" -}}
$ErrorActionPreference = "Continue"

# Trigger execution when these templates change:
# {{ include "private_dot_ssh/private_id_ed25519_dotfiles_master.tmpl" | sha256sum }}
# {{ include "private_dot_ssh/private_id_ed25519_dotfiles_server.tmpl" | sha256sum }}

$sshDir = "$HOME/.ssh"
$keys = @("id_ed25519_dotfiles_master", "id_ed25519_dotfiles_server")

Write-Host "--- Checking SSH Public Keys ---" -ForegroundColor Cyan

if (Test-Path $sshDir) {
    foreach ($key in $keys) {
        $privateKeyPath = Join-Path $sshDir $key
        $publicKeyPath = "$privateKeyPath.pub"
        
        Write-Host "Checking key: $key" -ForegroundColor Gray

        if (Test-Path $privateKeyPath) {
            Write-Host "  -> Private key found. Deriving public key..." -ForegroundColor Yellow
            try {
                $pubKeyContent = ssh-keygen -y -f "$privateKeyPath"
                if ($pubKeyContent) {
                    $pubKeyContent | Out-File -FilePath $publicKeyPath -Encoding ascii -NoNewline
                    Write-Host "  -> SUCCESS: Updated $publicKeyPath" -ForegroundColor Green
                } else {
                     Write-Warning "  -> ssh-keygen returned empty content for $key"
                }
            } catch {
                Write-Warning "  -> Failed to derive public key for ${key}: $_"
            }
        } else {
            Write-Host "  -> Private key NOT FOUND at $privateKeyPath" -ForegroundColor Red
        }
    }
} else {
    Write-Warning "SSH Directory not found at $sshDir"
}
{{- end -}}
