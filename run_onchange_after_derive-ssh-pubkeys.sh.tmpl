{{- if ne .chezmoi.os "windows" -}}
#!/bin/bash

# Trigger execution when these templates change:
# {{ include "private_dot_ssh/private_id_ed25519_dotfiles_master.tmpl" | sha256sum }}
# {{ include "private_dot_ssh/private_id_ed25519_dotfiles_server.tmpl" | sha256sum }}

# Color Definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

SSH_DIR="$HOME/.ssh"
KEYS=("id_ed25519_dotfiles_master" "id_ed25519_dotfiles_server")

echo -e "${CYAN}--- Checking SSH Public Keys ---${NC}"

if [ -d "$SSH_DIR" ]; then
    for key in "${KEYS[@]}"; do
        PRIVATE_KEY_PATH="$SSH_DIR/$key"
        PUBLIC_KEY_PATH="$PRIVATE_KEY_PATH.pub"

        echo -e "${GRAY}Checking key: $key${NC}"

        if [ -f "$PRIVATE_KEY_PATH" ]; then
            echo -e "${YELLOW}  -> Private key found. Deriving public key...${NC}"
            if ssh-keygen -y -f "$PRIVATE_KEY_PATH" > "$PUBLIC_KEY_PATH" 2>/dev/null; then
                if [ -s "$PUBLIC_KEY_PATH" ]; then
                    chmod 644 "$PUBLIC_KEY_PATH"
                    echo -e "${GREEN}  -> SUCCESS: Updated $PUBLIC_KEY_PATH${NC}"
                else
                    echo -e "${YELLOW}  -> ssh-keygen returned empty content for $key${NC}"
                fi
            else
                echo -e "${YELLOW}  -> Failed to derive public key for $key${NC}"
            fi
        else
            echo -e "${RED}  -> Private key NOT FOUND at $PRIVATE_KEY_PATH${NC}"
        fi
    done
else
    echo -e "${YELLOW}SSH Directory not found at $SSH_DIR${NC}"
fi
{{- end -}}
